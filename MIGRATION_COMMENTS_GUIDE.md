# ุฑุงูููุง Migration ุณุณุชู ฺฉุงููุชโูุง

ุงู migration script ุจุฑุง ุงุนูุงู ุชุบุฑุงุช ุณุณุชู ฺฉุงููุชโูุง ุฏุฑ ุฏุชุงุจุณ ุงุณุชูุงุฏู ูโุดูุฏ.

## ุชุบุฑุงุช ุงุนูุงู ุดุฏู

1. **ููุฏ `status` ุฏุฑ ุฌุฏูู `comments`**
   - ุงุถุงูู ฺฉุฑุฏู ููุฏ `status` ุจุง ููุงุฏุฑ: `pending`, `approved`, `rejected`
   - ฺฉุงููุชโูุง ููุฌูุฏ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุจู `approved` ุชุบุฑ ูโฺฉููุฏ

2. **ุฌุฏูู `comment_reactions`**
   - ุจุฑุง ุฐุฎุฑู ูุงฺฉ/ุฏุณูุงฺฉ ฺฉุงุฑุจุฑุงู
   - ุดุงูู ููุฏูุง: `id`, `comment_id`, `user_id`, `reaction`, `createdAt`, `updatedAt`
   - Unique constraint ุฑู `(comment_id, user_id)` ุจุฑุง ุฌููฺฏุฑ ุงุฒ ูุงฺฉ/ุฏุณูุงฺฉ ุชฺฉุฑุงุฑ

3. **ุฌุฏูู `comment_reports`**
   - ุจุฑุง ุฐุฎุฑู ฺฏุฒุงุฑุดโูุง ุชุฎูู ฺฉุงุฑุจุฑุงู
   - ุดุงูู ููุฏูุง: `id`, `comment_id`, `user_id`, `reason`, `createdAt`, `updatedAt`

4. **ุฌุฏูู `notifications`**
   - ุจุฑุง ุฐุฎุฑู ููุชูฺฉุดูโูุง ุงุฏูู
   - ุดุงูู ููุฏูุง: `id`, `type`, `comment_id`, `user_id`, `message`, `is_read`, `entity_type`, `entity_id`, `createdAt`, `updatedAt`

5. **Indexes**
   - ุงุถุงูู ฺฉุฑุฏู index ุจุฑุง `(section_type, section_id)` ุฏุฑ ุฌุฏูู `comments` ุจุฑุง ุจูุจูุฏ ุนููฺฉุฑุฏ

## ุฑูุด ุงุฌุฑุง

### 1. ูพุดุชุจุงูโฺฏุฑ ุงุฒ ุฏุชุงุจุณ (ุชูุตู ูโุดูุฏ)

```bash
# ุงฺฏุฑ ุงุฒ MySQL ุงุณุชูุงุฏู ูโฺฉูุฏ:
mysqldump -u [USERNAME] -p [DATABASE_NAME] > backup_before_comments_migration.sql

# ูุซุงู:
mysqldump -u root -p nobean_db > backup_before_comments_migration.sql
```

### 2. ุจุฑุฑุณ ุชูุธูุงุช ุฏุชุงุจุณ

ูุทูุฆู ุดูุฏ ฺฉู ูุงู `.env` ุฏุฑ ูุณุฑ `nobean-back/nobean/` ูุฌูุฏ ุฏุงุฑุฏ ู ุดุงูู ุงุทูุงุนุงุช ุฒุฑ ุงุณุช:

```env
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=your_database_name
DB_USER=your_username
DB_PASSWORD=your_password
```

### 3. ุงุฌุฑุง Migration

```bash
# ุจุฑู ุจู ูุณุฑ ูพุฑูฺู
cd nobean-back/nobean

# ุงุฌุฑุง migration script
node migrate-comments-system.js
```

### 4. ุจุฑุฑุณ ูุชุงุฌ

ูพุณ ุงุฒ ุงุฌุฑุง ูููู migrationุ ุจุงุฏ ูพุงูโูุง ุฒุฑ ุฑุง ุจุจูุฏ:

```
โ ุงุชุตุงู ุจู ุฏุชุงุจุณ ุจุฑูุฑุงุฑ ุดุฏ
โ ููุฏ status ุงุถุงูู ุดุฏ
โ ุฌุฏูู comment_reactions ุงุฌุงุฏ ุดุฏ
โ ุฌุฏูู comment_reports ุงุฌุงุฏ ุดุฏ
โ ุฌุฏูู notifications ุงุฌุงุฏ ุดุฏ
๐ Migration ุจุง ููููุช ุงูุฌุงู ุดุฏ!
```

## ูฺฉุงุช ููู

1. **Idempotent ุจูุฏู**: ุงู script ุจู ุตูุฑุช idempotent ููุดุชู ุดุฏู ุงุณุชุ ุนู ูโุชูุงูุฏ ุขู ุฑุง ฺูุฏู ุจุงุฑ ุงุฌุฑุง ฺฉูุฏ ุจุฏูู ูฺฏุฑุงู ุงุฒ ุฎุทุง. ุงฺฏุฑ ุฌุฏูู ุง ููุฏ ูุจูุงู ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ุงุฒ ุขู ุฑุฏ ูโุดูุฏ.

2. **ุฏุชุงุจุณ ูุดุชุฑฺฉ**: ุงฺฏุฑ ุฏุชุงุจุณ local ู production ฺฉ ุงุณุช (ุทุจู ฺฏูุชู ุดูุง)ุ ุจุนุฏ ุงุฒ ุงุฌุฑุง migration ุฑู ุณุฑูุฑุ ููู ฺุฒ ุขูุงุฏู ุงุณุช.

3. **ฺฉุงููุชโูุง ููุฌูุฏ**: ุชูุงู ฺฉุงููุชโูุง ููุฌูุฏ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุจู ูุถุนุช `approved` ุชุบุฑ ูโฺฉููุฏ.

4. **Foreign Keys**: ุชูุงู foreign key ูุง ุจุง `ON DELETE CASCADE` ุชูุธู ุดุฏูโุงูุฏุ ุนู ุจุง ุญุฐู ฺฉุงููุชุ ูุงฺฉูุดโูุงุ ฺฏุฒุงุฑุดโูุง ู ููุชูฺฉุดูโูุง ูุฑุจูุทู ูู ุญุฐู ูโุดููุฏ.

## ุฑูุน ูุดฺฉูุงุช

### ุฎุทุง: "Table already exists"
- ุงู ุฎุทุง ุทุจุน ุงุณุช ู ุจู ุงู ูุนู ุงุณุช ฺฉู ุฌุฏูู ูุจูุงู ุงุฌุงุฏ ุดุฏู ุงุณุช.
- Migration script ุงู ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ ู ุงุฒ ุขู ุฑุฏ ูโุดูุฏ.

### ุฎุทุง: "Column already exists"
- ุงู ุฎุทุง ุทุจุน ุงุณุช ู ุจู ุงู ูุนู ุงุณุช ฺฉู ููุฏ ูุจูุงู ุงุถุงูู ุดุฏู ุงุณุช.
- Migration script ุงู ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ ู ุงุฒ ุขู ุฑุฏ ูโุดูุฏ.

### ุฎุทุง: ุงุชุตุงู ุจู ุฏุชุงุจุณ
- ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุงุทูุงุนุงุช ุฏุชุงุจุณ ุฏุฑ `.env` ุฏุฑุณุช ุจุงุดุฏ.
- ูุทูุฆู ุดูุฏ ฺฉู ุฏุชุงุจุณ MySQL ุฏุฑ ุญุงู ุงุฌุฑุง ุงุณุช.
- ุจุฑุฑุณ ฺฉูุฏ ฺฉู ฺฉุงุฑุจุฑ ุฏุชุงุจุณ ุฏุณุชุฑุณ ูุงุฒู ุฑุง ุฏุงุฑุฏ.

### ุฎุทุง: Foreign key constraint
- ุงฺฏุฑ ุฌุฏูู `comments` ุง `users` ูุฌูุฏ ูุฏุงุฑุฏุ ุงุจุชุฏุง ุจุงุฏ ุขูโูุง ุฑุง ุงุฌุงุฏ ฺฉูุฏ.
- ูุทูุฆู ุดูุฏ ฺฉู ุฌุฏููโูุง ูพุงู ูุฌูุฏ ุฏุงุฑูุฏ.

## ุจุฑฺฏุดุช ุชุบุฑุงุช (Rollback)

ุงฺฏุฑ ูุงุฒ ุจู ุจุฑฺฏุดุช ุชุบุฑุงุช ุฏุงุฑุฏุ ูโุชูุงูุฏ ุงุฒ SQL ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

```sql
-- ุญุฐู ุฌุฏุงูู
DROP TABLE IF EXISTS notifications;
DROP TABLE IF EXISTS comment_reports;
DROP TABLE IF EXISTS comment_reactions;

-- ุญุฐู ููุฏ status ุงุฒ ุฌุฏูู comments
ALTER TABLE comments DROP COLUMN IF EXISTS status;
```

**โ๏ธ ุชูุฌู**: ุงู ุนููุงุช ุบุฑูุงุจู ุจุฑฺฏุดุช ุงุณุช ู ุชูุงู ุฏุงุฏูโูุง ูุฑุจูุทู ุฑุง ุญุฐู ูโฺฉูุฏ. ุญุชูุงู ูุจู ุงุฒ ุงุฌุฑุง ุงุฒ ุฏุชุงุจุณ ูพุดุชุจุงู ุจฺฏุฑุฏ.

## ุจุฑุฑุณ ูุถุนุช Migration

ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง migration ูุจูุงู ุงุฌุฑุง ุดุฏู ุงุณุช:

```sql
-- ุจุฑุฑุณ ููุฏ status
SELECT COLUMN_NAME, DATA_TYPE, COLUMN_DEFAULT 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = DATABASE() 
AND TABLE_NAME = 'comments' 
AND COLUMN_NAME = 'status';

-- ุจุฑุฑุณ ุฌุฏุงูู
SELECT TABLE_NAME 
FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_SCHEMA = DATABASE() 
AND TABLE_NAME IN ('comment_reactions', 'comment_reports', 'notifications');
```

